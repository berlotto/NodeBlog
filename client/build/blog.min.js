"use strict";!function(exports){exports.FilterModule=angular.module("chinook.filters",[]),exports.ServiceModule=angular.module("chinook.services",[]),exports.ProviderModule=angular.module("chinook.providers",[]),exports.DirectiveModule=angular.module("chinook.directives",[]),exports.CtrlModule=angular.module("chinook.controllers",[]),exports.MainModule=angular.module("chinook",["ngRoute","chinook.filters","chinook.services","chinook.providers","chinook.directives","chinook.controllers"])}(window),function(module,exports){function Localizer(defaultLocale){return function(key,locale){if(!key)return"";locale=locale||defaultLocale||navigator.language.split("-")[0];var temp=resources[key];if(!temp)return key;var value=temp[locale];return value||locale===defaultLocale||(value=temp[defaultLocale])?value:key}}var resources=exports.resources||{blog:{en:"blog",zh:"博客",ko:"블로그"},recentposts:{en:"Recent Posts",zh:"最近文章",ko:"최근포스트"},comments:{en:"comments",zh:"评论",ko:"댓글"},comment:{en:"comment",zh:"评论",ko:"댓글"},junglelaw:{en:"The Law of the Jungle",zh:"丛林里的法则",ko:"정글의 법칙"},welcomeMessage:{en:"Welcome to Jeff Jin's blog. Main topics include Single Page Application with Angular.JS, Node.JS, C#, ASP.net web api, NoSQL with MongoDB and RavenDB. Any interesting topics about .Net and JavaScript.",zh:"欢迎来到我的博客",ko:"정글의 법칙 블로그에 온것을 환영합니다."}};module.provider("localize",function(){var defaultLocale="en";this.setDefaultLocale=function(value){defaultLocale=value||defaultLocale},this.$get=["locale",function(locale){return new Localizer(locale)}]})}(window.ProviderModule,window),function(module){module.factory("adminBlogService",["$http","identity",function($http,identity){var addPost=function(post){return $http.post("/api/posts/",post,{transformRequest:[function(data){return data.createdOn=new Date,data.updatedOn=null,data.createdBy=identity.currentUser.name,data.updatedBy=null,data}].concat($http.defaults.transformRequest)})},updatePost=function(postId,post){return $http.put("/api/posts/"+postId,post,{transformRequest:[function(data){return data.updatedOn=new Date,data.updatedBy=identity.currentUser.name,data}].concat($http.defaults.transformRequest)})};return{addPost:addPost,updatePost:updatePost}}])}(window.ServiceModule),function(module){module.factory("adminTaskService",["$http",function($http){var addTask=function(){return $http.get("/api/tasks")},removeTask=function(id){return $http.delete("/api/tasks/"+id)};return{addTask:addTask,removeTask:removeTask}}])}(window.ServiceModule),function(module){module.factory("fileService",["$http",function($http){var upload=function(){return $http.post("/api/files")},download=function(id){return $http.get("/api/files/"+id)},remove=function(id){return $http.delete("/api/files/"+id)},list=function(){return $http.get("/api/files/")};return{upload:upload,download:download,remove:remove,list:list}}])}(window.ServiceModule),function(module){module.service("settingsService",["$http","identity",function($http,identity){var getSettings=function(){return $http.get("/api/settings/")},updateSettings=function(settings){return $http.put("/api/settings/",settings,{transformRequest:[function(data,headersGetter){headersGetter();data.updatedOn=new Date,data.updatedBy=identity.currentUser.name}].concat($http.defaults.transformRequest)})};return{getSettings:getSettings,updateSettings:updateSettings}}])}(window.ServiceModule),function(module){module.factory("authService",["$http",function($http){var authenticate=function(userName,pwd){return $http.post("/api/authenticate",{username:userName,password:pwd})},authorize=function(userName,pwd){return $http.post("/api/authorize",{username:userName,password:pwd})},getLoggedIn=function(){return $http.get("/api/loggedIn")};return{authenticate:authenticate,authorize:authorize,getLoggedIn:getLoggedIn}}])}(window.ServiceModule),function(module){module.factory("blogService",["$http","$q","$sce","commentService","identity","moment","md5","marked","validatorService",function($http,$q,$sce,commentService,identity,moment,md5,marked,validator){console.log("Initializing Blog Service");var getList=function(dateRange,maxSize){var queryString="";return dateRange&&(validator.isValidDateString(dateRange.from)&&(queryString=queryString+"from="+dateRange.from),validator.isValidDateString(dateRange.to)&&(queryString=queryString+"&to="+dateRange.to)),validator.isValidPositiveNumber(maxSize)&&(queryString=queryString?queryString+"&max="+maxSize:"max="+maxSize),queryString&&(queryString="?"+queryString),$http.get("/api/posts"+queryString)},getDetails=function(id){var deferred=$q.defer();if("new"===id||!id){var newPost={topic:"topic for the new post",urlLink:"",metaTitle:"",summary:"please write a summary",disableComment:!1,status:"draft",body:"new post content here"};return deferred.resolve({data:newPost}),deferred.promise}return $http.get("/api/posts/"+id,{transformResponse:$http.defaults.transformResponse.concat([function(data){return data?(data.markedBody=$sce.trustAsHtml(marked(data.body)),data.lastRevised=moment(data.updatedOn||data.createdOn).format("MMM Do YYYY"),commentService.parse(data.comments),data):null}])})};return{getList:getList,getDetails:getDetails}}])}(window.ServiceModule),function(module){module.factory("commentService",["$http","$q","$sce","moment","md5","identity","validatorService",function($http,$q,$sce,moment,md5,identity,validator){console.log("Initializing Comment Service");var getList=function(dateRange,maxSize){var queryString="";return dateRange&&(validator.isValidDateString(dateRange.from)&&(queryString=queryString+"from="+dateRange.from),validator.isValidDateString(dateRange.to)&&(queryString=queryString+"&to="+dateRange.to)),validator.isValidPositiveNumber(maxSize)&&(queryString=queryString+"&max="+maxSize),queryString&&(queryString="?"+queryString),$http.get("/api/comments"+queryString)},parse=function(comments){return _.forEach(comments,function(cmt){parseOne(cmt)}),comments},parseOne=function(cmt){return cmt.markedBody=$sce.trustAsHtml(marked(cmt.body)),cmt.dateString=moment(cmt.createdOn).format("dddd, MMMM Do YYYY, h:mm:ss a"),cmt.authorEmail&&(cmt.authorEmailHash=md5(cmt.authorEmail)),cmt},saveComment=function(comment,postId){return comment._id?$http.put("/api/comments/",{postId:postId,comment:comment},{transformRequest:[function(data){return data.updatedOn=new Date,data.updatedBy=identity.currentUser.name,data}]}):$http.post("/api/comments/",{postId:postId,comment:comment},{transformRequest:[function(data){return data.createdOn=new Date,data.createdBy=identity.currentUser.name,data.updatedOn=null,data.updatedBy=null,data}].concat($http.defaults.transformRequest)})},deleteComment=function(commentId){return $http.delete("/api/comments/",{commentId:commentId})};return{getList:getList,save:saveComment,parse:parse,parseOne:parseOne,"delete":deleteComment}}])}(window.ServiceModule),function(module){module.factory("entityManager",["$location","storage",function(){}])}(window.ServiceModule),function(module){module.factory("httpInterceptor",["$q","$location",function($q,$location){return{request:function(config){return config||$q.when(config)},requestError:function(rejection){return console.log(" request error method"),$q.reject(rejection)},response:function(response){return response||$q.when(response)},responseError:function(rejection){return console.log(" response error method"),403===rejection.status?$location.path("/#!/login").replace():$location.path("/404").replace(),$q.reject(rejection)}}}]),module.config(function($httpProvider){$httpProvider.interceptors.push("httpInterceptor")})}(window.ServiceModule),function(module){module.factory("socketService",["$rootScope","$window",function($rootScope,$window){var socket=$window.io.connect();return{on:function(eventName,callback){socket.on(eventName,function(){var args=arguments;$rootScope.$apply(function(){callback.apply(socket,args)})})},emit:function(eventName,data,callback){socket.emit(eventName,data,function(){var args=arguments;$rootScope.$apply(function(){callback&&callback.apply(socket,args)})})},removeListeners:function(eventName){socket.removeAllListeners(eventName)}}}])}(window.ServiceModule),function(module){module.factory("storageService",["$window",function(){var set=function(key,value){amplify.store(key,value)},get=function(key){return amplify.store(key)};return{get:get,set:set}}])}(window.ServiceModule),function(module){module.factory("validatorService",["$sce","moment","md5",function(){console.log("Initializing Validator Service");var isValidPositiveNumber=function(n){return!!n},isValidDateString=function(s){return!!s};return{isValidPositiveNumber:isValidPositiveNumber,isValidDateString:isValidDateString}}])}(window.ServiceModule),function(module){module.value("identity",{currentUser:{}}),module.value("marked",marked),module.value("moment",moment),module.value("md5",hex_md5),module.value("locale","en")}(window.ServiceModule),function(module){module.filter("dateFormat",["moment",function(moment){return function(value,type){return moment(value).format("short"===type?"MMM Do YY":"long"===type?"MMMM Do YYYY, h:mm:ss a":"MMM Do YYYY")}}])}(window.FilterModule),function(module){module.filter("pgLang",["$q",function(){var dirtyWords=["fuck","gay","lesbian"];return function(values){var results=_.filter(values,function(value){return-1===_.indexOf(dirtyWords,value)});return results}}])}(window.FilterModule),function(module){module.directive("jjComments",["entityManager",function(){return function(){}}])}(window.DirectiveModule),function(module){module.directive("jjFlash",["$timeout",function(){return function(){}}])}(window.DirectiveModule),function(module){module.directive("jjFooter",["$window",function(){return{restrict:"E",replace:!0,templateUrl:"/app/js/directives/templates/footer.html",link:function(){}}}])}(window.DirectiveModule),function(module){module.directive("jjHeader",["$window",function(){return{restrict:"E",replace:!0,templateUrl:"/app/js/directives/templates/header.html",controller:"HeaderCtrl"}}])}(window.DirectiveModule),function(module){module.directive("jjMarkdownEditor",["$window",function(){return{restrict:"EA",replace:!0,templateUrl:"/app/js/directives/templates/markdown-editor.html",scope:{content:"="},link:function(){var converter=Markdown.getSanitizingConverter(),editor=new Markdown.Editor(converter);editor.run()}}}])}(window.DirectiveModule),function(module){module.directive("jjNewComment",["entityManager",function(){return function(){}}])}(window.DirectiveModule),function(module){module.directive("jjSearchForm",["$window",function(){return{restrict:"E",replace:!0,transclude:!1,templateUrl:"/app/js/directives/templates/search.html",controller:"BlogSearchCtrl"}}])}(window.DirectiveModule),function(module){module.directive("jjWip",["entityManager",function(){return function(){}}])}(window.DirectiveModule),function(module){module.directive("ngEnter",function(){return function(scope,element,attrs){element.bind("keydown keypress",function(event){13===event.which&&(scope.$apply(function(){scope.$eval(attrs.ngEnter)}),event.preventDefault())})}})}(window.DirectiveModule),function(module){module.controller("AdminCommentsCtrl",["$scope","$routeParams","adminBlogService",function(){console.log("Initializing AdminCommentsCtrl Controller")}])}(window.CtrlModule),function(module){module.controller("AdminFilesCtrl",["$scope","$routeParams","fileService","authService",function($scope,$routeParams,fileService){console.log("Initializing AdminFilesCtrl Controller"),fileService.list().then(function(result){$scope.files=result.data})}])}(window.CtrlModule),function(module){module.controller("AdminHeaderCtrl",["$scope","$routeParams","blogService",function(){console.log("Initializing AdminHeaderCtrl Controller")}])}(window.CtrlModule),function(module){module.controller("AdminListCtrl",["$scope","$rootScope","$location","$routeParams",function(){console.log("Initializing AdminListCtrl Controller")}])}(window.CtrlModule),function(module){module.controller("AdminPingBacksCtrl",["$scope","$routeParams","adminBlogService","authService",function(){console.log("Initializing AdminPingBacksCtrl Controller")}])}(window.CtrlModule),function(module){module.controller("AdminPostEditCtrl",["$scope","$rootScope","$routeParams","$location","$window","$timeout","$q","blogService","adminBlogService","storageService","identity","marked",function($scope,$rootScope,$routeParams,$location,$window,$timeout,$q,blogService,adminBlogService,storageService,identity,marked){console.log("Initializing AdminPostEditCtrl Controller");var postId=$routeParams.pid;console.log("Edit post with id "+postId);var key=$location.path()+JSON.stringify(identity.currentUser),tempPost=storageService.get(key);tempPost&&$window.confirm("Would like to restore unsaved work?")?($scope.post=tempPost,storageService.set(key,null)):blogService.getDetails(postId).then(function(result){if($scope.markDown=marked,result.data&&result.data.comments)for(var i=0;i<result.data.comments.length;i++)result.data.comments[i].markedBody=marked(result.data.comments[i].body),result.data.comments[i].authorEmail&&(result.data.comments[i].authorEmailHash=hex_md5(result.data.comments[i].authorEmail));$scope.post=result.data},function(result){$window.alert(result.status+","+result.data)}),$scope.save=function(post){var successCallback=function(result){console.log(result),$location.path("/posts/"+post.urlLink)};post._id?adminBlogService.updatePost(post.urlLink,post).success(successCallback):adminBlogService.addPost(post).success(successCallback)},$scope.$watch("post",function(newValue){console.log(key),storageService.set(key,newValue)},!0)}])}(window.CtrlModule),function(module){module.controller("AdminPostsCtrl",["$scope","$routeParams","blogService",function($scope,$routeParams,blogService){console.log("Initializing AdminPostsCtrl Controller");var loadPosts=function(){blogService.getList({from:$routeParams.from,to:$routeParams.to},20).success(function(data){$scope.posts=data}).error(function(data,status){$scope.posts=[],alert(status+","+data)})};$scope.deletePost=function(id){confirm("Are you sure you want to delete "+id)&&blogService.deletePost(id).then(function(){loadPosts()})},loadPosts()}])}(window.CtrlModule),function(module){module.controller("AdminSettingsCtrl",["$scope","$routeParams","settingsService",function(){console.log("Initializing AdminSettingsCtrl Controller")}])}(window.CtrlModule),function(module){module.controller("AdminTasksCtrl",["$scope","$routeParams","adminTaskService","authService",function(){console.log("Initializing AdminTasksCtrl Controller")}])}(window.CtrlModule),function(module){module.controller("BlogDetailsCtrl",["$scope","$routeParams","blogService","commentService","socketService","identity",function($scope,$routeParams,blogService,commentService,socketService,identity){console.log("Initializing Blog Details Controller");var postId=$routeParams.pid,commentInsertKey="comments-inserted-"+postId;return $scope.addComment=function(cmt){commentService.save(cmt,postId).then(function(){$scope.post.activeComment={}})},$scope.editComment=function(cmt){$scope.editCmt=cmt},$scope.updateComment=function(cmt){commentService.save(cmt,postId).then(function(){$scope.editCmt=null})},socketService.on(commentInsertKey,function(data){console.log(commentInsertKey,data),commentService.parseOne(data),$scope.post.comments.push(data)}),$scope.$on("$destroy",function(){socketService.removeListeners(commentInsertKey)}),blogService.getDetails(postId).success(function(result){$scope.hasEditRight=identity.currentUser&&(identity.currentUser.isAdmin||identity.currentUser.isOwner),$scope.post=result}).error(function(data,status){console.error(status+","+data),$scope.hasEditRight=!1,$scope.post={}})}])}(window.CtrlModule),function(module){module.controller("BlogListCtrl",["$scope","blogService","$routeParams",function($scope,blogService,$routeParams){return console.log("Initializing Blog List Controller"),blogService.getList({from:$routeParams.from,to:$routeParams.to},20).success(function(data){$scope.posts=data}).error(function(data,status){console.error(status+","+data),$scope.posts=[]})}])}(window.CtrlModule),function(module){module.controller("BlogSearchCtrl",["$scope","$location",function($scope,$location){console.log("Initializing Blog Search Controller"),$scope.search=function(keyword){console.log("Searching for "+keyword),$location.path("/searchResult/"+keyword)}}])}(CtrlModule),function(module){module.controller("ErrorCtrl",["$scope","$routeParams",function($scope){console.log("Initializing Error Controller"),$scope.headerText="error"}])}(window.CtrlModule),function(module){module.controller("HeaderCtrl",["$scope","localize",function($scope){console.log("Initializing Header Controller"),$scope.headerText="The law of the jungle"}])}(window.CtrlModule),function(module){module.controller("SiteLoginCtrl",["$scope","$rootScope","$location","authService","identity",function($scope,$rootScope,$location,authService,identity){console.log("Initializing Site Login Controller"),$scope.login=function(username,password){console.log("validating user name "+username+" with password "+password),authService.authenticate(username,password).then(function(result){console.log("success for "+result),identity.currentUser=result.data,$location.path("/admin")},function(reason){console.error(reason.data),$location.path("/login").replace()})}}])}(CtrlModule),function(module){var checkAuthentication=function($q,$timeout,$http,$location,$rootScope){var deferred=$q.defer();return $http.get("/api/loggedIn").success(function(user){user?$timeout(deferred.resolve,0):($rootScope.message="You need to log in.",$timeout(function(){deferred.reject()},0),$location.url("/login"))}),deferred.promise};module.config(["$routeProvider",function($routeProvider){$routeProvider.when("/",{templateUrl:"/app/partials/posts.html",controller:"BlogListCtrl"}),$routeProvider.when("/login",{templateUrl:"/app/partials/login.html",controller:"SiteLoginCtrl"}),$routeProvider.when("/posts/:pid",{templateUrl:"/app/partials/blogDetails.html",controller:"BlogDetailsCtrl"}),$routeProvider.when("/advancedSearch/:key/:start/:end",{templateUrl:"/app/partials/advancedSearch.html",controller:"BlogSearchCtrl"}),$routeProvider.when("/searchResult",{templateUrl:"/app/partials/searchResult.html",controller:"BlogSearchCtrl"}),$routeProvider.when("/admin",{templateUrl:"/app/partials/admin/adminList.html",controller:"AdminListCtrl",resolve:{isAuthenticated:checkAuthentication}}),$routeProvider.when("/admin/posts",{templateUrl:"/app/partials/admin/posts.html",controller:"AdminPostsCtrl",resolve:{isAuthenticated:checkAuthentication}}),$routeProvider.when("/admin/posts/new",{templateUrl:"/app/partials/admin/create.html",controller:"AdminPostEditCtrl",resolve:{isAuthenticated:checkAuthentication}}),$routeProvider.when("/admin/posts/:pid",{templateUrl:"/app/partials/admin/edit.html",controller:"AdminPostEditCtrl",resolve:{isAuthenticated:checkAuthentication}}),$routeProvider.when("/admin/comments",{templateUrl:"/app/partials/admin/comments.html",controller:"AdminCommentsCtrl",resolve:{isAuthenticated:checkAuthentication}}),$routeProvider.when("/admin/tasks",{templateUrl:"/app/partials/admin/tasks.html",controller:"AdminTasksCtrl",resolve:{isAuthenticated:checkAuthentication}}),$routeProvider.when("/admin/files",{templateUrl:"/app/partials/admin/files.html",controller:"AdminFilesCtrl",resolve:{isAuthenticated:checkAuthentication}}),$routeProvider.when("/admin/pingBacks",{templateUrl:"/app/partials/admin/pingBacks.html",controller:"AdminPingBacksCtrl",resolve:{isAuthenticated:checkAuthentication}}),$routeProvider.when("/admin/settings",{templateUrl:"/app/partials/admin/settings.html",controller:"AdminSettingsCtrl",resolve:{isAuthenticated:checkAuthentication}}),$routeProvider.when("/404",{templateUrl:"/app/partials/error.html",controller:"ErrorCtrl"}),$routeProvider.otherwise({redirectTo:"/"})}]),module.config(["$locationProvider",function($locationProvider){$locationProvider.html5Mode(!1).hashPrefix("!")}]),module.config(["localizeProvider",function(localizeProvider){console.log("configuring localize providers"),localizeProvider.setDefaultLocale("en")}]),module.run(function($rootScope,$window){$rootScope.r=$window.r})}(window.MainModule);